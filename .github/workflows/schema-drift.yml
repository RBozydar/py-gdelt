name: Schema Drift Detection

on:
  schedule:
    - cron: '0 8 * * 1'  # Weekly on Monday at 8 AM UTC
  workflow_dispatch:

permissions:
  issues: write
  contents: read
  id-token: write  # Required for Claude OAuth

jobs:
  schema-drift:
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - uses: actions/checkout@v6

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: '3.12'

      - name: Install dependencies
        run: |
          pip install uv
          uv sync --all-extras

      - name: Run schema drift tests
        id: tests
        run: |
          uv run pytest tests/integration/test_schema_drift.py -v 2>&1 | tee output.txt
        continue-on-error: true

      - name: Check for drift warnings
        id: check
        run: |
          if grep -q "SchemaDriftWarning\|UnknownCodeWarning" output.txt; then
            echo "drift_detected=true" >> $GITHUB_OUTPUT
          fi

      - name: Analyze drift with Claude
        if: steps.check.outputs.drift_detected == 'true'
        id: claude_analysis
        continue-on-error: true
        uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          prompt: |
            Analyze the schema drift test output in output.txt in the current directory.

            Context: This is a Python client library for GDELT (Global Database of Events, Language, and Tone).
            The tests compare live API/file data against our Pydantic models and lookup tables.

            Warning types to look for:
            - SchemaDriftWarning: Fields added/removed from API responses vs our models
            - UnknownCodeWarning: CAMEO codes, country codes, or GKG themes not in our lookup tables

            Provide your analysis as JSON with these keys:
            - summary: Brief description of what drift was detected
            - root_cause: Why this likely happened
            - affected_files: Array of specific files/models needing updates
            - priority: One of "critical", "high", "medium", "low"
            - suggested_fix: Actionable fix approach

            Focus on actionable insights. Reference specific model classes and lookup files.
          claude_args: '--model claude-opus-4-5 --max-turns 5 --allowed-tools "Read"'

      - name: Find existing drift issue
        if: steps.check.outputs.drift_detected == 'true'
        id: find_issue
        uses: actions/github-script@v8
        with:
          script: |
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              labels: 'schema-drift',
              state: 'open'
            });
            if (issues.data.length > 0) {
              core.setOutput('issue_number', issues.data[0].number);
            }

      - name: Update or create issue
        if: steps.check.outputs.drift_detected == 'true'
        uses: actions/github-script@v8
        env:
          CLAUDE_RESULT: ${{ steps.claude_analysis.outputs.result }}
        with:
          script: |
            const fs = require('fs');
            const output = fs.readFileSync('output.txt', 'utf8');
            const issueNumber = '${{ steps.find_issue.outputs.issue_number }}';

            // Parse Claude's analysis
            let claudeAnalysis = '';
            try {
              const claudeResult = process.env.CLAUDE_RESULT || '';
              // Try to extract JSON from Claude's response
              const jsonMatch = claudeResult.match(/\{[\s\S]*\}/);
              if (jsonMatch) {
                const analysis = JSON.parse(jsonMatch[0]);
                const affectedFiles = (analysis.affected_files || [])
                  .map(f => '- `' + f + '`')
                  .join('\n');
                claudeAnalysis = `### AI Analysis

            **Priority:** ${analysis.priority || 'unknown'}

            **Summary:** ${analysis.summary || 'No summary available'}

            **Root Cause:** ${analysis.root_cause || 'Unknown'}

            **Affected Files:**
            ${affectedFiles || '_None identified_'}

            **Suggested Fix:** ${analysis.suggested_fix || 'Review the warnings manually'}

            ---

            `;
              }
            } catch (e) {
              console.log('Could not parse Claude analysis:', e.message);
            }

            const body = `## Schema Drift Detected - ${new Date().toISOString().split('T')[0]}

            ${claudeAnalysis}\`\`\`
            ${output.substring(0, 50000)}
            \`\`\`

            ### Action Required
            1. Review the AI analysis and warnings above
            2. Update models/lookups if needed
            3. Close this issue when resolved

            ---
            *Auto-generated by schema drift workflow with Claude analysis*`;

            if (issueNumber) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: parseInt(issueNumber),
                body: body
              });
            } else {
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: '[Schema Drift] Changes detected',
                body: body,
                labels: ['schema-drift', 'needs-review']
              });
            }

      - name: Fail workflow if drift detected
        if: steps.check.outputs.drift_detected == 'true'
        run: exit 1
