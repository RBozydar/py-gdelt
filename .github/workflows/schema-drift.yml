name: Schema Drift Detection

on:
  schedule:
    - cron: '0 8 * * 1'  # Weekly on Monday at 8 AM UTC
  workflow_dispatch:

jobs:
  schema-drift:
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install dependencies
        run: |
          pip install uv
          uv sync --all-extras

      - name: Run schema drift tests
        id: tests
        run: |
          uv run pytest tests/integration/test_schema_drift.py -v 2>&1 | tee output.txt
        continue-on-error: true

      - name: Check for drift warnings
        id: check
        run: |
          if grep -q "SchemaDriftWarning\|UnknownCodeWarning" output.txt; then
            echo "drift_detected=true" >> $GITHUB_OUTPUT
          fi

      - name: Find existing drift issue
        if: steps.check.outputs.drift_detected == 'true'
        id: find_issue
        uses: actions/github-script@v7
        with:
          script: |
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              labels: 'schema-drift',
              state: 'open'
            });
            if (issues.data.length > 0) {
              core.setOutput('issue_number', issues.data[0].number);
            }

      - name: Update or create issue
        if: steps.check.outputs.drift_detected == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const output = fs.readFileSync('output.txt', 'utf8');
            const issueNumber = '${{ steps.find_issue.outputs.issue_number }}';
            const body = `## Schema Drift Detected - ${new Date().toISOString().split('T')[0]}

            \`\`\`
            ${output.substring(0, 60000)}
            \`\`\`

            ### Action Required
            1. Review the warnings above
            2. Update models/lookups if needed
            3. Close this issue when resolved

            ---
            *Auto-generated by schema drift workflow*`;

            if (issueNumber) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: parseInt(issueNumber),
                body: body
              });
            } else {
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: '[Schema Drift] Changes detected',
                body: body,
                labels: ['schema-drift', 'needs-review']
              });
            }
