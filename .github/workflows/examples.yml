name: Examples Verification

on:
  schedule:
    - cron: '0 9 * * 1'  # Weekly on Monday at 9 AM UTC
  workflow_dispatch:

jobs:
  run-examples:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install dependencies
        run: |
          pip install uv
          uv sync --all-extras

      - name: Run examples
        id: examples
        run: |
          set +e  # Don't exit on first failure
          failed=0

          echo "=== Running examples ===" | tee output.txt

          for example in examples/*.py; do
            if [[ "$example" == *"bigquery"* ]]; then
              echo "SKIP: $example (requires BigQuery credentials)" | tee -a output.txt
              continue
            fi

            echo "" | tee -a output.txt
            echo "=== Running: $example ===" | tee -a output.txt

            # Run with timeout and capture exit code
            timeout 120 uv run python "$example" 2>&1 | tee -a output.txt
            exit_code=${PIPESTATUS[0]}

            if [ $exit_code -ne 0 ]; then
              echo "FAILED: $example (exit code: $exit_code)" | tee -a output.txt
              failed=1
            else
              echo "SUCCESS: $example" | tee -a output.txt
            fi
          done

          echo "" | tee -a output.txt
          echo "=== Summary ===" | tee -a output.txt

          if [ $failed -eq 1 ]; then
            echo "Some examples failed!" | tee -a output.txt
            echo "examples_failed=true" >> $GITHUB_OUTPUT
          else
            echo "All examples passed!" | tee -a output.txt
          fi

      - name: Find existing issue
        if: steps.examples.outputs.examples_failed == 'true'
        id: find_issue
        uses: actions/github-script@v7
        with:
          script: |
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              labels: 'examples-broken',
              state: 'open'
            });
            if (issues.data.length > 0) {
              core.setOutput('issue_number', issues.data[0].number);
            }

      - name: Update or create issue
        if: steps.examples.outputs.examples_failed == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const output = fs.readFileSync('output.txt', 'utf8');
            const issueNumber = '${{ steps.find_issue.outputs.issue_number }}';
            const body = `## Examples Verification Failed - ${new Date().toISOString().split('T')[0]}

            \`\`\`
            ${output.substring(0, 60000)}
            \`\`\`

            ### Action Required
            1. Review the failed examples above
            2. Fix broken examples or update API calls
            3. Close this issue when resolved

            ---
            *Auto-generated by examples workflow*`;

            if (issueNumber) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: parseInt(issueNumber),
                body: body
              });
            } else {
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: '[Examples] Verification failed',
                body: body,
                labels: ['examples-broken', 'needs-review']
              });
            }

      - name: Fail workflow if examples failed
        if: steps.examples.outputs.examples_failed == 'true'
        run: exit 1
